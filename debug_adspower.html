<!DOCTYPE html>
<html>
<head>
    <title>AdsPower检测调试</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>AdsPower检测调试页面</h1>
    
    <div id="status-container">
        <span id="status-text">初始状态</span>
        <div id="status-loading" style="display: none;">检测中...</div>
        <div id="install-guide" style="display: none;">安装指南</div>
    </div>
    
    <button onclick="checkAdsPowerInstallation()">检测AdsPower</button>
    
    <div id="debug-info"></div>
    
    <script>
    function checkAdsPowerInstallation() {
        console.log('开始检测AdsPower...');
        
        const statusLoading = document.getElementById('status-loading');
        const statusText = document.getElementById('status-text');
        const installGuide = document.getElementById('install-guide');
        const debugInfo = document.getElementById('debug-info');
        
        // 显示加载状态
        statusLoading.style.display = 'inline-block';
        statusText.textContent = '正在检测AdsPower安装状态...';
        statusText.className = 'text-muted';
        installGuide.style.display = 'none';
        
        // 检测AdsPower是否安装
        const apiHost = 'local.adspower.net';
        const apiPort = '50325';
        const apiUrl = `http://${apiHost}:${apiPort}`;
        
        debugInfo.innerHTML = `<p>API URL: ${apiUrl}</p>`;
        
        $.ajax({
            url: '/api/check_adspower_installation',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                api_host: apiHost,
                api_port: apiPort,
                api_url: apiUrl
            }),
            timeout: 5000
        })
        .done(function(response) {
            console.log('API响应:', response);
            statusLoading.style.display = 'none';
            
            debugInfo.innerHTML += `<p>响应: ${JSON.stringify(response)}</p>`;
            
            if (response.success) {
                statusText.innerHTML = '✅ AdsPower已安装并正在运行';
                statusText.className = 'text-success';
                installGuide.style.display = 'none';
                
                if (response.user_count > 0) {
                    statusText.innerHTML += ` (检测到 ${response.user_count} 个用户配置)`;
                }
            } else {
                statusText.innerHTML = '⚠️ ' + response.message;
                statusText.className = 'text-warning';
                installGuide.style.display = 'block';
            }
        })
        .fail(function(xhr) {
            console.error('API调用失败:', xhr);
            statusLoading.style.display = 'none';
            statusText.innerHTML = '❌ 无法连接到AdsPower (可能未安装或未启动)';
            statusText.className = 'text-danger';
            installGuide.style.display = 'block';
            
            debugInfo.innerHTML += `<p>错误: ${xhr.status} - ${xhr.statusText}</p>`;
        });
    }
    
    // 页面加载完成后自动检测
    $(document).ready(function() {
        console.log('页面加载完成，开始自动检测...');
        checkAdsPowerInstallation();
    });
    </script>
</body>
</html>