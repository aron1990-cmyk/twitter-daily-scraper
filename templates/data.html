{% extends "base.html" %}

{% block title %}æ•°æ®æŸ¥çœ‹ - TwitteræŠ“å–ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<!-- é¡µé¢æ ‡é¢˜ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2>
                <i class="fas fa-database me-2"></i>
                æ•°æ®æŸ¥çœ‹
            </h2>
            <div class="btn-group" role="group">
                <button onclick="exportData()" class="btn btn-success">
                    <i class="fas fa-file-excel me-2"></i>
                    å¯¼å‡ºExcel
                </button>
                <button onclick="syncToFeishu()" class="btn btn-info">
                    <i class="fas fa-cloud-upload-alt me-2"></i>
                    åŒæ­¥é£ä¹¦
                </button>
                <button onclick="validateFeishuData()" class="btn btn-warning">
                    <i class="fas fa-check-double me-2"></i>
                    éªŒè¯æ•°æ®
                </button>
            </div>
        </div>
    </div>
</div>

<!-- æ•°æ®ç»Ÿè®¡ -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="stats-icon text-primary mb-2">
                    <i class="fab fa-twitter"></i>
                </div>
                <h4 class="text-primary">{{ data_stats.total_tweets }}</h4>
                <p class="text-muted mb-0">æ€»æ¨æ–‡æ•°</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="stats-icon text-success mb-2">
                    <i class="fas fa-calendar-day"></i>
                </div>
                <h4 class="text-success">{{ data_stats.today_tweets }}</h4>
                <p class="text-muted mb-0">ä»Šæ—¥æ–°å¢</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="stats-icon text-warning mb-2">
                    <i class="fas fa-heart"></i>
                </div>
                <h4 class="text-warning">{{ data_stats.avg_likes }}</h4>
                <p class="text-muted mb-0">å¹³å‡ç‚¹èµæ•°</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="stats-icon text-info mb-2">
                    <i class="fas fa-retweet"></i>
                </div>
                <h4 class="text-info">{{ data_stats.avg_retweets }}</h4>
                <p class="text-muted mb-0">å¹³å‡è½¬å‘æ•°</p>
            </div>
        </div>
    </div>
</div>

<!-- ç­›é€‰å’Œæœç´¢ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="GET" class="row g-3">
                    <div class="col-md-3">
                        <label for="search" class="form-label">æœç´¢å†…å®¹</label>
                        <input type="text" class="form-control" id="search" name="search" 
                               value="{{ request.args.get('search', '') }}" placeholder="æ¨æ–‡å†…å®¹æˆ–ç”¨æˆ·å">
                    </div>
                    <div class="col-md-2">
                        <label for="task_id" class="form-label">ä»»åŠ¡ç­›é€‰</label>
                        <select class="form-select" id="task_id" name="task_id">
                            <option value="">å…¨éƒ¨ä»»åŠ¡</option>
                            {% for task in tasks %}
                                <option value="{{ task.id }}" {{ 'selected' if request.args.get('task_id')|int == task.id }}>{{ task.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="min_likes" class="form-label">æœ€å°ç‚¹èµæ•°</label>
                        <input type="number" class="form-control" id="min_likes" name="min_likes" 
                               value="{{ request.args.get('min_likes', '') }}" min="0">
                    </div>
                    <div class="col-md-2">
                        <label for="min_retweets" class="form-label">æœ€å°è½¬å‘æ•°</label>
                        <input type="number" class="form-control" id="min_retweets" name="min_retweets" 
                               value="{{ request.args.get('min_retweets', '') }}" min="0">
                    </div>
                    <div class="col-md-2">
                        <label for="sort" class="form-label">æ’åºæ–¹å¼</label>
                        <select class="form-select" id="sort" name="sort">
                            <option value="created_desc" {{ 'selected' if request.args.get('sort') == 'created_desc' }}>æ—¶é—´(æ–°åˆ°æ—§)</option>
                            <option value="created_asc" {{ 'selected' if request.args.get('sort') == 'created_asc' }}>æ—¶é—´(æ—§åˆ°æ–°)</option>
                            <option value="likes_desc" {{ 'selected' if request.args.get('sort') == 'likes_desc' }}>ç‚¹èµæ•°(é«˜åˆ°ä½)</option>
                            <option value="retweets_desc" {{ 'selected' if request.args.get('sort') == 'retweets_desc' }}>è½¬å‘æ•°(é«˜åˆ°ä½)</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-outline-primary">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- æ¨æ–‡åˆ—è¡¨ -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">æ¨æ–‡æ•°æ® ({{ pagination.total }} æ¡)</h5>
            </div>
            <div class="card-body">
                {% if tweets %}
                    <div class="row">
                        {% for tweet in tweets %}
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-start mb-3">
                                        <div class="flex-shrink-0">
                                            {% if tweet.user_avatar %}
                                                <img src="{{ tweet.user_avatar }}" alt="{{ tweet.username }}" 
                                                     class="rounded-circle" width="40" height="40">
                                            {% else %}
                                                <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center" 
                                                     style="width: 40px; height: 40px; color: white;">
                                                    <i class="fas fa-user"></i>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="flex-grow-1 ms-3">
                                            <h6 class="mb-1">
                                                <strong>{{ tweet.user_display_name or tweet.username }}</strong>
                                                <small class="text-muted">@{{ tweet.username }}</small>
                                            </h6>
                                            <small class="text-muted">
                                                <i class="fas fa-clock me-1"></i>
                                                {% if tweet.publish_time %}
                                                    {{ tweet.publish_time }}
                                                {% else %}
                                                    {{ tweet.scraped_at.strftime('%Y-%m-%d %H:%M') if tweet.scraped_at else 'æœªçŸ¥æ—¶é—´' }}
                                                {% endif %}
                                            </small>
                                        </div>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                                    type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-ellipsis-h"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                {% if tweet.url %}
                                                    <li><a class="dropdown-item" href="{{ tweet.url }}" target="_blank">
                                                        <i class="fas fa-external-link-alt me-2"></i>æŸ¥çœ‹åŸæ¨æ–‡
                                                    </a></li>
                                                {% endif %}
                                                <li><a class="dropdown-item" href="#" onclick="copyTweet('{{ tweet.id }}')">
                                                    <i class="fas fa-copy me-2"></i>å¤åˆ¶å†…å®¹
                                                </a></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item text-danger" href="#" onclick="deleteTweet('{{ tweet.id }}')">
                                                    <i class="fas fa-trash me-2"></i>åˆ é™¤
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <div class="tweet-content mb-3">
                                        <p class="mb-2">{{ tweet.content }}</p>
                                        {% if tweet.hashtags %}
                                            <div class="mb-2">
                                                {% for hashtag in tweet.hashtags.split(',') %}
                                                    <span class="badge bg-light text-primary me-1">#{{ hashtag.strip() }}</span>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <div class="d-flex gap-3">
                                            <small class="text-muted">
                                                <i class="fas fa-heart text-danger me-1"></i>
                                                {{ tweet.likes or 0 }}
                                            </small>
                                            <small class="text-muted">
                                                <i class="fas fa-retweet text-success me-1"></i>
                                                {{ tweet.retweets or 0 }}
                                            </small>
                                            <small class="text-muted">
                                                <i class="fas fa-comment text-info me-1"></i>
                                                {{ tweet.comments or 0 }}
                                            </small>
                                        </div>
                                        <small class="text-muted">
                                            {% if tweet.task %}
                                                <span class="badge bg-secondary">{{ tweet.task.name }}</span>
                                            {% endif %}
                                        </small>
                                    </div>
                                    
                                    <div class="d-grid">
                                        <a href="{{ url_for('tweet_detail', tweet_id=tweet.id) }}" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-eye me-2"></i>æŸ¥çœ‹è¯¦æƒ…
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- åˆ†é¡µ -->
                    {% if pagination.pages > 1 %}
                        <nav aria-label="æ¨æ–‡åˆ†é¡µ">
                            <ul class="pagination">
                                {% if pagination.has_prev %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('data', page=pagination.prev_num, search=request.args.get('search', ''), task_id=request.args.get('task_id', ''), min_likes=request.args.get('min_likes', ''), min_retweets=request.args.get('min_retweets', ''), sort=request.args.get('sort', '')) }}">
                                            <i class="fas fa-chevron-left"></i>
                                        </a>
                                    </li>
                                {% endif %}
                                
                                {% for page_num in pagination.iter_pages() %}
                                    {% if page_num %}
                                        {% if page_num != pagination.page %}
                                            <li class="page-item">
                                                <a class="page-link" href="{{ url_for('data', page=page_num, search=request.args.get('search', ''), task_id=request.args.get('task_id', ''), min_likes=request.args.get('min_likes', ''), min_retweets=request.args.get('min_retweets', ''), sort=request.args.get('sort', '')) }}">{{ page_num }}</a>
                                            </li>
                                        {% else %}
                                            <li class="page-item active">
                                                <span class="page-link">{{ page_num }}</span>
                                            </li>
                                        {% endif %}
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link">...</span>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if pagination.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('data', page=pagination.next_num, search=request.args.get('search', ''), task_id=request.args.get('task_id', ''), min_likes=request.args.get('min_likes', ''), min_retweets=request.args.get('min_retweets', ''), sort=request.args.get('sort', '')) }}">
                                            <i class="fas fa-chevron-right"></i>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    {% endif %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="fab fa-twitter fa-4x text-muted mb-3"></i>
                        <h4 class="text-muted">æš‚æ— æ•°æ®</h4>
                        <p class="text-muted">è¿˜æ²¡æœ‰æŠ“å–åˆ°ä»»ä½•æ¨æ–‡æ•°æ®</p>
                        <a href="{{ url_for('tasks') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>
                            åˆ›å»ºæŠ“å–ä»»åŠ¡
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- æ•°æ®åˆ†æå›¾è¡¨ -->
{% if tweets %}
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    æ¯æ—¥æ¨æ–‡æ•°é‡
                </h5>
            </div>
            <div class="card-body">
                <canvas id="dailyTweetsChart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    çƒ­é—¨è¯é¢˜æ ‡ç­¾
                </h5>
            </div>
            <div class="card-body">
                <canvas id="hashtagsChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    äº’åŠ¨æ•°æ®è¶‹åŠ¿
                </h5>
            </div>
            <div class="card-body">
                <canvas id="engagementChart" height="100"></canvas>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
function exportData() {
    console.log('ğŸ“Š [Excelå¯¼å‡º] å¼€å§‹å¯¼å‡ºæµç¨‹');
    const button = event.target;
    const originalText = showLoading(button);
    
    // è·å–å½“å‰ç­›é€‰å‚æ•°
    const params = new URLSearchParams();
    
    const search = document.getElementById('search').value;
    if (search) {
        params.append('search', search);
        console.log(`ğŸ” [Excelå¯¼å‡º] æœç´¢æ¡ä»¶: ${search}`);
    }
    
    const taskId = document.getElementById('task_id').value;
    if (taskId) {
        params.append('task_id', taskId);
        console.log(`ğŸ“‹ [Excelå¯¼å‡º] ä»»åŠ¡ID: ${taskId}`);
    }
    
    const minLikes = document.getElementById('min_likes').value;
    if (minLikes) {
        params.append('min_likes', minLikes);
        console.log(`ğŸ‘ [Excelå¯¼å‡º] æœ€å°ç‚¹èµæ•°: ${minLikes}`);
    }
    
    const minRetweets = document.getElementById('min_retweets').value;
    if (minRetweets) {
        params.append('min_retweets', minRetweets);
        console.log(`ğŸ”„ [Excelå¯¼å‡º] æœ€å°è½¬å‘æ•°: ${minRetweets}`);
    }
    
    // æ„å»ºå¯¼å‡ºURL
    const exportUrl = '/api/data/export' + (params.toString() ? '?' + params.toString() : '');
    console.log(`ğŸŒ [Excelå¯¼å‡º] å¯¼å‡ºURL: ${exportUrl}`);
    
    // æ˜¾ç¤ºå¯¼å‡ºè¿›åº¦æç¤º
    showAlert('æ­£åœ¨å‡†å¤‡å¯¼å‡ºæ–‡ä»¶ï¼Œè¯·ç¨å€™...', 'info');
    
    // ä½¿ç”¨fetch APIè¿›è¡Œæ›´å¥½çš„é”™è¯¯å¤„ç†
    fetch(exportUrl)
        .then(response => {
            console.log(`ğŸ“Š [Excelå¯¼å‡º] æ”¶åˆ°å“åº”ï¼ŒçŠ¶æ€ç : ${response.status}`);
            
            if (!response.ok) {
                throw new Error(`å¯¼å‡ºå¤±è´¥: ${response.status} ${response.statusText}`);
            }
            
            // æ£€æŸ¥å“åº”ç±»å‹
            const contentType = response.headers.get('content-type');
            console.log(`ğŸ“„ [Excelå¯¼å‡º] å“åº”ç±»å‹: ${contentType}`);
            
            if (contentType && contentType.includes('application/json')) {
                // å¦‚æœè¿”å›JSONï¼Œè¯´æ˜æœ‰é”™è¯¯
                return response.json().then(data => {
                    throw new Error(data.error || 'å¯¼å‡ºå¤±è´¥');
                });
            }
            
            // è·å–æ–‡ä»¶å
            const contentDisposition = response.headers.get('content-disposition');
            let filename = 'tweets_export.xlsx';
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="?([^"]+)"?/);
                if (filenameMatch) {
                    filename = filenameMatch[1];
                }
            }
            console.log(`ğŸ“ [Excelå¯¼å‡º] æ–‡ä»¶å: ${filename}`);
            
            // ä¸‹è½½æ–‡ä»¶
            return response.blob().then(blob => {
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                
                console.log('âœ… [Excelå¯¼å‡º] æ–‡ä»¶ä¸‹è½½æˆåŠŸ');
                $('.alert').remove();
                showAlert('Excelæ–‡ä»¶å¯¼å‡ºæˆåŠŸï¼', 'success');
            });
        })
        .catch(error => {
            console.error('âŒ [Excelå¯¼å‡º] å¯¼å‡ºå¤±è´¥:', error);
            $('.alert').remove();
            showAlert('å¯¼å‡ºå¤±è´¥: ' + error.message, 'danger');
        })
        .finally(() => {
            console.log('ğŸ”š [Excelå¯¼å‡º] å¯¼å‡ºæµç¨‹å®Œæˆï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€');
            hideLoading(button, originalText);
        });
}

function syncToFeishu() {
    console.log('ğŸš€ [é£ä¹¦åŒæ­¥] å¼€å§‹åŒæ­¥æµç¨‹');
    const button = event.target;
    const originalText = showLoading(button);
    
    // è·å–å½“å‰é€‰æ‹©çš„ä»»åŠ¡ID
    const taskId = document.getElementById('task_id').value;
    console.log(`ğŸ“‹ [é£ä¹¦åŒæ­¥] é€‰æ‹©çš„ä»»åŠ¡ID: ${taskId}`);
    
    // å¦‚æœæ²¡æœ‰é€‰æ‹©ä»»åŠ¡ï¼Œæç¤ºç”¨æˆ·
    if (!taskId) {
        console.warn('âš ï¸ [é£ä¹¦åŒæ­¥] æœªé€‰æ‹©ä»»åŠ¡IDï¼Œç»ˆæ­¢åŒæ­¥');
        hideLoading(button, originalText);
        showAlert('è¯·å…ˆé€‰æ‹©è¦åŒæ­¥çš„ä»»åŠ¡', 'warning');
        return;
    }
    
    // æ˜¾ç¤ºåŒæ­¥ç¡®è®¤å¯¹è¯æ¡†
    console.log('ğŸ’¬ [é£ä¹¦åŒæ­¥] æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†');
    if (!confirm(`ç¡®å®šè¦å°†ä»»åŠ¡ ${taskId} çš„æ‰€æœ‰æ•°æ®åŒæ­¥åˆ°é£ä¹¦å—ï¼Ÿ\n\næ³¨æ„ï¼š\n1. åªä¼šåŒæ­¥å°šæœªåŒæ­¥è¿‡çš„æ•°æ®\n2. ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æŸ¥é‡å¤å†…å®¹\n3. åŒæ­¥è¿‡ç¨‹å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´`)) {
        console.log('âŒ [é£ä¹¦åŒæ­¥] ç”¨æˆ·å–æ¶ˆåŒæ­¥');
        hideLoading(button, originalText);
        return;
    }
    
    console.log('âœ… [é£ä¹¦åŒæ­¥] ç”¨æˆ·ç¡®è®¤åŒæ­¥ï¼Œå¼€å§‹æ‰§è¡Œ');
    
    // æ˜¾ç¤ºåŒæ­¥è¿›åº¦æç¤º
    console.log('ğŸ” [é£ä¹¦åŒæ­¥] æ˜¾ç¤ºæ£€æŸ¥é‡å¤å†…å®¹æç¤º');
    showAlert('æ­£åœ¨æ£€æŸ¥é‡å¤å†…å®¹...', 'info');
    
    // æ„å»ºè¯·æ±‚æ•°æ® - ä½¿ç”¨FormDataæ ¼å¼ï¼Œå› ä¸ºåç«¯æœŸæœ›formæ•°æ®
    var formData = new FormData();
    formData.append('task_id', taskId);
    console.log('ğŸ“¦ [é£ä¹¦åŒæ­¥] æ„å»ºè¯·æ±‚æ•°æ®å®Œæˆ');
    
    // æ›´æ–°è¿›åº¦æç¤º
    setTimeout(function() {
        console.log('ğŸ”„ [é£ä¹¦åŒæ­¥] æ›´æ–°è¿›åº¦æç¤ºä¸º"æ­£åœ¨åŒæ­¥ä¸­..."');
        // ç§»é™¤ä¹‹å‰çš„æç¤º
        $('.alert').remove();
        showAlert('æ­£åœ¨åŒæ­¥ä¸­...', 'info');
    }, 1000);
    
    console.log('ğŸŒ [é£ä¹¦åŒæ­¥] å‘é€AJAXè¯·æ±‚åˆ° /sync_feishu');
    $.ajax({
        url: '/sync_feishu',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false
    })
        .done(function(response) {
            console.log('âœ… [é£ä¹¦åŒæ­¥] æ”¶åˆ°æœåŠ¡å™¨å“åº”:', response);
            // æ¸…é™¤è¿›åº¦æç¤º
            $('.alert').remove();
            
            if (response.success) {
                console.log('ğŸ‰ [é£ä¹¦åŒæ­¥] åŒæ­¥æˆåŠŸ');
                // æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ•°æ®åŒæ­¥
                var report = response.report || {};
                console.log('ğŸ“Š [é£ä¹¦åŒæ­¥] åŒæ­¥æŠ¥å‘Š:', report);
                var message = '';
                
                if (report.to_sync === 0) {
                    // æ²¡æœ‰æ–°æ•°æ®éœ€è¦åŒæ­¥
                    message = 'åŒæ­¥å®Œæˆï¼ä»»åŠ¡ ' + taskId + ' çš„æ‰€æœ‰æ•°æ®ï¼ˆ' + (report.total_tweets || 0) + ' æ¡ï¼‰éƒ½å·²ç»åŒæ­¥è¿‡äº†ã€‚';
                    console.log('â„¹ï¸ [é£ä¹¦åŒæ­¥] æ— æ–°æ•°æ®éœ€è¦åŒæ­¥');
                } else {
                    // æœ‰æ–°æ•°æ®åŒæ­¥
                    message = 'åŒæ­¥å®Œæˆï¼æˆåŠŸåŒæ­¥äº† ' + (report.synced_count || report.to_sync || 0) + ' æ¡æ–°æ•°æ®åˆ°é£ä¹¦ã€‚';
                    if (report.already_synced > 0) {
                        message += 'å¦æœ‰ ' + report.already_synced + ' æ¡æ•°æ®ä¹‹å‰å·²åŒæ­¥ã€‚';
                    }
                    console.log('ğŸ“ˆ [é£ä¹¦åŒæ­¥] æˆåŠŸåŒæ­¥ ' + (report.synced_count || report.to_sync || 0) + ' æ¡æ–°æ•°æ®');
                }
                
                console.log('ğŸ’¬ [é£ä¹¦åŒæ­¥] æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯:', message);
                showAlert(message, 'success');
                
                // è¯¢é—®æ˜¯å¦åˆ·æ–°é¡µé¢
                setTimeout(function() {
                    console.log('ğŸ”„ [é£ä¹¦åŒæ­¥] è¯¢é—®æ˜¯å¦åˆ·æ–°é¡µé¢');
                    if (confirm('æ˜¯å¦åˆ·æ–°é¡µé¢æŸ¥çœ‹æœ€æ–°çŠ¶æ€ï¼Ÿ')) {
                        console.log('ğŸ”„ [é£ä¹¦åŒæ­¥] ç”¨æˆ·ç¡®è®¤åˆ·æ–°é¡µé¢');
                        location.reload();
                    } else {
                        console.log('âŒ [é£ä¹¦åŒæ­¥] ç”¨æˆ·å–æ¶ˆåˆ·æ–°é¡µé¢');
                    }
                }, 2000);
            } else {
                console.error('âŒ [é£ä¹¦åŒæ­¥] åŒæ­¥å¤±è´¥:', response.message || 'æœªçŸ¥é”™è¯¯');
                showAlert('åŒæ­¥å¤±è´¥: ' + (response.message || 'æœªçŸ¥é”™è¯¯'), 'danger');
            }
        })
        .fail(function(xhr) {
            console.error('âŒ [é£ä¹¦åŒæ­¥] AJAXè¯·æ±‚å¤±è´¥');
            console.error('ğŸ“Š [é£ä¹¦åŒæ­¥] é”™è¯¯çŠ¶æ€ç :', xhr.status);
            console.error('ğŸ“Š [é£ä¹¦åŒæ­¥] é”™è¯¯çŠ¶æ€æ–‡æœ¬:', xhr.statusText);
            console.error('ğŸ“Š [é£ä¹¦åŒæ­¥] å“åº”å†…å®¹:', xhr.responseText);
            
            // æ¸…é™¤è¿›åº¦æç¤º
            $('.alert').remove();
            
            var errorMessage = 'åŒæ­¥å¤±è´¥';
            if (xhr.responseJSON) {
                console.error('ğŸ“Š [é£ä¹¦åŒæ­¥] è§£æåˆ°JSONé”™è¯¯å“åº”:', xhr.responseJSON);
                errorMessage += ': ' + (xhr.responseJSON.message || xhr.responseJSON.error || 'æœªçŸ¥é”™è¯¯');
            } else if (xhr.responseText) {
                try {
                    var errorData = JSON.parse(xhr.responseText);
                    console.error('ğŸ“Š [é£ä¹¦åŒæ­¥] æ‰‹åŠ¨è§£æJSONé”™è¯¯å“åº”:', errorData);
                    errorMessage += ': ' + (errorData.message || errorData.error || 'æœªçŸ¥é”™è¯¯');
                } catch (e) {
                    console.error('ğŸ“Š [é£ä¹¦åŒæ­¥] JSONè§£æå¤±è´¥:', e);
                    errorMessage += ': æœåŠ¡å™¨å“åº”å¼‚å¸¸';
                }
            }
            console.error('ğŸ’¬ [é£ä¹¦åŒæ­¥] æœ€ç»ˆé”™è¯¯æ¶ˆæ¯:', errorMessage);
            showAlert(errorMessage, 'danger');
        })
        .always(function() {
            console.log('ğŸ”š [é£ä¹¦åŒæ­¥] AJAXè¯·æ±‚å®Œæˆï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€');
            hideLoading(button, originalText);
        });
}

function copyTweet(tweetId) {
    var tweetCard = $("[onclick=\"copyTweet('" + tweetId + "')\"]").closest('.card');
    var content = tweetCard.find('.tweet-content p').text();
    
    navigator.clipboard.writeText(content).then(function() {
        showAlert('æ¨æ–‡å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    }).catch(function() {
        showAlert('å¤åˆ¶å¤±è´¥', 'danger');
    });
}

function deleteTweet(tweetId) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¨æ–‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        $.ajax({
            url: '/data/' + tweetId,
            type: 'DELETE'
        })
        .done(function(response) {
            showAlert('æ¨æ–‡å·²åˆ é™¤ï¼', 'success');
            setTimeout(function() { location.reload(); }, 1000);
        })
        .fail(function(xhr) {
            var error = xhr.responseJSON ? xhr.responseJSON.error : 'åˆ é™¤å¤±è´¥';
            showAlert('åˆ é™¤å¤±è´¥: ' + error, 'danger');
        });
    }
}

function validateFeishuData() {
    console.log('ğŸ” [é£ä¹¦éªŒè¯] å¼€å§‹æ•°æ®éªŒè¯æµç¨‹');
    const button = event.target;
    const originalText = showLoading(button);
    
    // è·å–å½“å‰é€‰æ‹©çš„ä»»åŠ¡ID
    const taskId = document.getElementById('task_id').value;
    console.log(`ğŸ“‹ [é£ä¹¦éªŒè¯] é€‰æ‹©çš„ä»»åŠ¡ID: ${taskId}`);
    
    // å¦‚æœæ²¡æœ‰é€‰æ‹©ä»»åŠ¡ï¼Œæç¤ºç”¨æˆ·
    if (!taskId) {
        console.warn('âš ï¸ [é£ä¹¦éªŒè¯] æœªé€‰æ‹©ä»»åŠ¡IDï¼Œç»ˆæ­¢éªŒè¯');
        hideLoading(button, originalText);
        showAlert('è¯·å…ˆé€‰æ‹©è¦éªŒè¯çš„ä»»åŠ¡', 'warning');
        return;
    }
    
    // æ˜¾ç¤ºéªŒè¯ç¡®è®¤å¯¹è¯æ¡†
    console.log('ğŸ’¬ [é£ä¹¦éªŒè¯] æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†');
    if (!confirm(`ç¡®å®šè¦éªŒè¯ä»»åŠ¡ ${taskId} çš„é£ä¹¦æ•°æ®åŒæ­¥å‡†ç¡®æ€§å—ï¼Ÿ\n\néªŒè¯è¿‡ç¨‹å°†ï¼š\n1. è·å–é£ä¹¦è¡¨æ ¼ä¸­çš„æ•°æ®\n2. ä¸æœ¬åœ°æ•°æ®è¿›è¡Œæ¯”å¯¹\n3. ç”Ÿæˆè¯¦ç»†çš„éªŒè¯æŠ¥å‘Š`)) {
        console.log('âŒ [é£ä¹¦éªŒè¯] ç”¨æˆ·å–æ¶ˆéªŒè¯');
        hideLoading(button, originalText);
        return;
    }
    
    console.log('âœ… [é£ä¹¦éªŒè¯] ç”¨æˆ·ç¡®è®¤éªŒè¯ï¼Œå¼€å§‹æ‰§è¡Œ');
    
    // æ˜¾ç¤ºéªŒè¯è¿›åº¦æç¤º
    console.log('ğŸ” [é£ä¹¦éªŒè¯] æ˜¾ç¤ºéªŒè¯è¿›åº¦æç¤º');
    showAlert('æ­£åœ¨è·å–é£ä¹¦æ•°æ®...', 'info');
    
    // æ›´æ–°è¿›åº¦æç¤º
    setTimeout(function() {
        console.log('ğŸ”„ [é£ä¹¦éªŒè¯] æ›´æ–°è¿›åº¦æç¤ºä¸º"æ­£åœ¨æ¯”å¯¹æ•°æ®..."');
        $('.alert').remove();
        showAlert('æ­£åœ¨æ¯”å¯¹æ•°æ®...', 'info');
    }, 1500);
    
    console.log(`ğŸŒ [é£ä¹¦éªŒè¯] å‘é€AJAXè¯·æ±‚åˆ° /api/data/validate_feishu/${taskId}`);
    $.ajax({
        url: `/api/data/validate_feishu/${taskId}`,
        type: 'POST',
        contentType: 'application/json'
    })
        .done(function(response) {
            console.log('âœ… [é£ä¹¦éªŒè¯] æ”¶åˆ°æœåŠ¡å™¨å“åº”:', response);
            // æ¸…é™¤è¿›åº¦æç¤º
            $('.alert').remove();
            
            if (response.success) {
                console.log('ğŸ‰ [é£ä¹¦éªŒè¯] éªŒè¯æˆåŠŸ');
                const report = response.validation_report || {};
                const summary = report.summary || {};
                console.log('ğŸ“Š [é£ä¹¦éªŒè¯] éªŒè¯æŠ¥å‘Š:', report);
                
                // æ„å»ºéªŒè¯ç»“æœæ¶ˆæ¯
                let message = `æ•°æ®éªŒè¯å®Œæˆï¼\n\n`;
                message += `ğŸ“Š åŒæ­¥å‡†ç¡®ç‡: ${summary.sync_accuracy || 0}%\n`;
                message += `âœ… åŒ¹é…è®°å½•: ${report.details?.matched_records_count || 0} æ¡\n`;
                
                if (report.details?.missing_in_feishu_count > 0) {
                    message += `âš ï¸ é£ä¹¦ç¼ºå¤±: ${report.details.missing_in_feishu_count} æ¡\n`;
                }
                
                if (report.details?.extra_in_feishu_count > 0) {
                    message += `â„¹ï¸ é£ä¹¦å¤šä½™: ${report.details.extra_in_feishu_count} æ¡\n`;
                }
                
                if (report.details?.field_mismatches_count > 0) {
                    message += `ğŸ”„ å­—æ®µä¸åŒ¹é…: ${report.details.field_mismatches_count} æ¡\n`;
                }
                
                message += `\nè´¨é‡è¯„ä¼°: ${report.quality_assessment?.description || 'æœªçŸ¥'}`;
                
                // æ ¹æ®å‡†ç¡®ç‡é€‰æ‹©æç¤ºç±»å‹
                const alertType = summary.sync_accuracy >= 95 ? 'success' : 
                                summary.sync_accuracy >= 85 ? 'warning' : 'danger';
                
                console.log('ğŸ’¬ [é£ä¹¦éªŒè¯] æ˜¾ç¤ºéªŒè¯ç»“æœ:', message);
                showAlert(message, alertType);
                
                // å¦‚æœæœ‰é—®é¢˜ï¼Œè¯¢é—®æ˜¯å¦æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š
                if (summary.sync_accuracy < 100) {
                    setTimeout(function() {
                        if (confirm('å‘ç°æ•°æ®ä¸ä¸€è‡´ï¼Œæ˜¯å¦åœ¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šï¼Ÿ')) {
                            console.log('ğŸ“‹ [é£ä¹¦éªŒè¯] è¯¦ç»†éªŒè¯æŠ¥å‘Š:', report);
                            if (report.missing_samples) {
                                console.log('âŒ [é£ä¹¦éªŒè¯] é£ä¹¦ç¼ºå¤±æ•°æ®æ ·ä¾‹:', report.missing_samples);
                            }
                            if (report.mismatch_samples) {
                                console.log('ğŸ”„ [é£ä¹¦éªŒè¯] å­—æ®µä¸åŒ¹é…æ ·ä¾‹:', report.mismatch_samples);
                            }
                            alert('è¯¦ç»†æŠ¥å‘Šå·²è¾“å‡ºåˆ°æµè§ˆå™¨æ§åˆ¶å°ï¼Œè¯·æŒ‰F12æŸ¥çœ‹ã€‚');
                        }
                    }, 3000);
                }
            } else {
                const errorMsg = response.error || 'éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥é£ä¹¦é…ç½®å’Œç½‘ç»œè¿æ¥';
                console.error('âŒ [é£ä¹¦éªŒè¯] éªŒè¯å¤±è´¥:', errorMsg);
                showAlert('éªŒè¯å¤±è´¥: ' + errorMsg, 'danger');
            }
        })
        .fail(function(xhr) {
            console.error('âŒ [é£ä¹¦éªŒè¯] AJAXè¯·æ±‚å¤±è´¥');
            console.error('ğŸ“Š [é£ä¹¦éªŒè¯] é”™è¯¯çŠ¶æ€ç :', xhr.status);
            console.error('ğŸ“Š [é£ä¹¦éªŒè¯] é”™è¯¯çŠ¶æ€æ–‡æœ¬:', xhr.statusText);
            console.error('ğŸ“Š [é£ä¹¦éªŒè¯] å“åº”å†…å®¹:', xhr.responseText);
            
            // æ¸…é™¤è¿›åº¦æç¤º
            $('.alert').remove();
            
            let errorMessage = 'éªŒè¯å¤±è´¥';
            if (xhr.responseJSON) {
                console.error('ğŸ“Š [é£ä¹¦éªŒè¯] è§£æåˆ°JSONé”™è¯¯å“åº”:', xhr.responseJSON);
                errorMessage += ': ' + (xhr.responseJSON.error || xhr.responseJSON.message || 'æœåŠ¡å™¨è¿”å›é”™è¯¯ä½†æœªæä¾›è¯¦ç»†ä¿¡æ¯');
            } else if (xhr.responseText) {
                try {
                    const errorData = JSON.parse(xhr.responseText);
                    console.error('ğŸ“Š [é£ä¹¦éªŒè¯] æ‰‹åŠ¨è§£æJSONé”™è¯¯å“åº”:', errorData);
                    errorMessage += ': ' + (errorData.error || errorData.message || 'æœåŠ¡å™¨è¿”å›é”™è¯¯ä½†æœªæä¾›è¯¦ç»†ä¿¡æ¯');
                } catch (e) {
                    console.error('ğŸ“Š [é£ä¹¦éªŒè¯] JSONè§£æå¤±è´¥:', e);
                    errorMessage += ': æœåŠ¡å™¨å“åº”å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                }
            } else {
                errorMessage += ': ç½‘ç»œè¿æ¥å¼‚å¸¸æˆ–æœåŠ¡å™¨æ— å“åº”';
            }
            console.error('ğŸ’¬ [é£ä¹¦éªŒè¯] æœ€ç»ˆé”™è¯¯æ¶ˆæ¯:', errorMessage);
            showAlert(errorMessage, 'danger');
        })
        .always(function() {
            console.log('ğŸ”š [é£ä¹¦éªŒè¯] AJAXè¯·æ±‚å®Œæˆï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€');
            hideLoading(button, originalText);
        });
}

// å›¾è¡¨åˆå§‹åŒ–
$(document).ready(function() {
    // æ£€æŸ¥æ˜¯å¦æœ‰å›¾è¡¨å…ƒç´ å­˜åœ¨
    if (document.getElementById('dailyTweetsChart')) {
        // è·å–å›¾è¡¨æ•°æ®
        $.get('/api/chart_data')
            .done(function(data) {
                // æ¯æ—¥æ¨æ–‡æ•°é‡å›¾è¡¨
                var dailyCtx = document.getElementById('dailyTweetsChart').getContext('2d');
                new Chart(dailyCtx, {
                    type: 'line',
                    data: {
                        labels: data.daily_tweets.labels,
                        datasets: [{
                            label: 'æ¨æ–‡æ•°é‡',
                            data: data.daily_tweets.data,
                            borderColor: '#1da1f2',
                            backgroundColor: 'rgba(29, 161, 242, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                
                // çƒ­é—¨è¯é¢˜æ ‡ç­¾å›¾è¡¨
                var hashtagsCtx = document.getElementById('hashtagsChart').getContext('2d');
                new Chart(hashtagsCtx, {
                    type: 'doughnut',
                    data: {
                        labels: data.hashtags.labels,
                        datasets: [{
                            data: data.hashtags.data,
                            backgroundColor: [
                                '#1da1f2', '#14171a', '#657786', '#aab8c2', 
                                '#e1e8ed', '#f7f9fa', '#ffad1f', '#f91880'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
                
                // äº’åŠ¨æ•°æ®è¶‹åŠ¿å›¾è¡¨
                var engagementCtx = document.getElementById('engagementChart').getContext('2d');
                new Chart(engagementCtx, {
                    type: 'line',
                    data: {
                        labels: data.engagement.labels,
                        datasets: [
                            {
                                label: 'å¹³å‡ç‚¹èµæ•°',
                                data: data.engagement.likes,
                                borderColor: '#f91880',
                                backgroundColor: 'rgba(249, 24, 128, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'å¹³å‡è½¬å‘æ•°',
                                data: data.engagement.retweets,
                                borderColor: '#17bf63',
                                backgroundColor: 'rgba(23, 191, 99, 0.1)',
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            })
            .fail(function() {
                console.log('å›¾è¡¨æ•°æ®åŠ è½½å¤±è´¥');
            });
    }
});
</script>
{% endblock %}