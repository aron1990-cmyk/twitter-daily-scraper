{% extends "base.html" %}

{% block title %}é¡µé¢ç»“æ„åˆ†æå™¨ - TwitteræŠ“å–ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h1 class="h3 mb-3">
                        <i class="fas fa-search-plus me-2"></i>
                        æ™ºèƒ½é¡µé¢ç»“æ„åˆ†æå™¨
                    </h1>
                    <p class="text-muted mb-0">è‡ªåŠ¨è¯†åˆ«é¡µé¢ç»“æ„ï¼Œé…ç½®é‡‡é›†è§„åˆ™ï¼Œç±»ä¼¼å…«çˆªé±¼é‡‡é›†å™¨çš„åŠŸèƒ½</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
        <div class="col-md-4">
            <!-- URLè¾“å…¥ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-link me-2"></i>
                        ç›®æ ‡é¡µé¢
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="targetUrl" class="form-label">é¡µé¢URL</label>
                        <input type="url" class="form-control" id="targetUrl" 
                               placeholder="https://x.com/search?q=å…³é”®è¯" 
                               value="https://x.com">
                    </div>
                    <div class="mb-3">
                        <label for="pageType" class="form-label">é¡µé¢ç±»å‹</label>
                        <select class="form-select" id="pageType">
                            <option value="auto">è‡ªåŠ¨æ£€æµ‹</option>
                            <option value="twitter_search">Twitteræœç´¢é¡µ</option>
                            <option value="twitter_profile">Twitterä¸ªäººä¸»é¡µ</option>
                            <option value="twitter_home">Twitteré¦–é¡µ</option>
                            <option value="custom">è‡ªå®šä¹‰é¡µé¢</option>
                        </select>
                    </div>
                    <button class="btn btn-primary w-100" onclick="analyzePageStructure()">
                        <i class="fas fa-play me-2"></i>
                        å¼€å§‹åˆ†æé¡µé¢ç»“æ„
                    </button>
                </div>
            </div>

            <!-- åˆ†æç»“æœ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        åˆ†æç»“æœ
                    </h5>
                </div>
                <div class="card-body">
                    <div id="analysisResults">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-info-circle fa-2x mb-2"></i>
                            <p>ç‚¹å‡»"å¼€å§‹åˆ†æ"æ¥è¯†åˆ«é¡µé¢ç»“æ„</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åšä¸»ç®¡ç† -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>
                        åšä¸»ç®¡ç†
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="influencerUrl" class="form-label">åšä¸»ä¸»é¡µURL</label>
                        <input type="url" class="form-control" id="influencerUrl" 
                               placeholder="https://x.com/username">
                    </div>
                    <div class="mb-3">
                        <label for="influencerName" class="form-label">åšä¸»åç§°</label>
                        <input type="text" class="form-control" id="influencerName" 
                               placeholder="è¾“å…¥åšä¸»åç§°">
                    </div>
                    <div class="mb-3">
                        <label for="influencerCategory" class="form-label">åˆ†ç±»</label>
                        <select class="form-select" id="influencerCategory">
                            <option value="æé’±">æé’±</option>
                            <option value="æŠ•æ”¾">æŠ•æ”¾</option>
                            <option value="å‰¯ä¸šå¹²è´§">å‰¯ä¸šå¹²è´§</option>
                            <option value="æƒ…ç»ªç±»">æƒ…ç»ªç±»</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="influencerDescription" class="form-label">æè¿°</label>
                        <textarea class="form-control" id="influencerDescription" rows="2" 
                                  placeholder="åšä¸»æè¿°ä¿¡æ¯"></textarea>
                    </div>
                    <button class="btn btn-primary w-100 mb-2" onclick="addInfluencer()">
                        <i class="fas fa-plus me-2"></i>
                        æ·»åŠ åšä¸»
                    </button>
                    <button class="btn btn-outline-secondary w-100" onclick="showInfluencerList()">
                        <i class="fas fa-list me-2"></i>
                        ç®¡ç†åšä¸»åˆ—è¡¨
                    </button>
                </div>
            </div>

            <!-- é‡‡é›†é…ç½® -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>
                        é‡‡é›†é…ç½®
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="maxItems" class="form-label">æœ€å¤§é‡‡é›†æ•°é‡</label>
                        <input type="number" class="form-control" id="maxItems" value="50" min="1" max="1000">
                    </div>
                    <div class="mb-3">
                        <label for="scrollDelay" class="form-label">æ»šåŠ¨å»¶è¿Ÿ(ç§’)</label>
                        <input type="number" class="form-control" id="scrollDelay" value="2" min="0.5" max="10" step="0.5">
                    </div>
                    <div class="mb-3">
                        <label for="maxScrolls" class="form-label">æœ€å¤§æ»šåŠ¨æ¬¡æ•°</label>
                        <input type="number" class="form-control" id="maxScrolls" value="50" min="1" max="200">
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="enableSmartScroll" checked>
                        <label class="form-check-label" for="enableSmartScroll">
                            å¯ç”¨æ™ºèƒ½æ»šåŠ¨
                        </label>
                    </div>
                    <div class="mb-3">
                        <label for="selectedInfluencers" class="form-label">é€‰æ‹©åšä¸»</label>
                        <select class="form-select" id="selectedInfluencers" multiple size="3">
                            <!-- åŠ¨æ€åŠ è½½åšä¸»åˆ—è¡¨ -->
                        </select>
                        <div class="form-text">æŒ‰ä½Ctrl/Cmdå¯å¤šé€‰åšä¸»</div>
                    </div>
                    <button class="btn btn-success w-100" onclick="startInfluencerScraping()" id="startInfluencerScrapingBtn">
                        <i class="fas fa-robot me-2"></i>
                        æŠ“å–é€‰ä¸­åšä¸»
                    </button>
                    <button class="btn btn-info w-100 mt-2" onclick="startIntelligentScraping()" disabled id="startScrapingBtn">
                        <i class="fas fa-search me-2"></i>
                        æ™ºèƒ½é¡µé¢åˆ†æ
                    </button>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ä¸»è¦å†…å®¹ -->
        <div class="col-md-8">
            <!-- é¡µé¢ç»“æ„å¯è§†åŒ– -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-sitemap me-2"></i>
                        é¡µé¢ç»“æ„å¯è§†åŒ–
                    </h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="showStructureView()">
                            <i class="fas fa-tree"></i> ç»“æ„è§†å›¾
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="showSelectorView()">
                            <i class="fas fa-code"></i> é€‰æ‹©å™¨è§†å›¾
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="showPreviewView()">
                            <i class="fas fa-eye"></i> é¢„è§ˆè§†å›¾
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="structureVisualization">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-sitemap fa-3x mb-3"></i>
                            <h5>é¡µé¢ç»“æ„å°†åœ¨è¿™é‡Œæ˜¾ç¤º</h5>
                            <p>åˆ†æé¡µé¢åï¼Œæ‚¨å°†çœ‹åˆ°è¯†åˆ«å‡ºçš„å…ƒç´ ç»“æ„</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å­—æ®µæ˜ å°„é…ç½® -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-map me-2"></i>
                        å­—æ®µæ˜ å°„é…ç½®
                    </h5>
                </div>
                <div class="card-body">
                    <div id="fieldMapping">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-map-marked-alt fa-2x mb-2"></i>
                            <p>åˆ†æé¡µé¢åé…ç½®å­—æ®µæ˜ å°„</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å®æ—¶é‡‡é›†ç»“æœ -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        å®æ—¶é‡‡é›†ç»“æœ
                    </h5>
                    <div>
                        <span class="badge bg-primary" id="collectedCount">0</span>
                        <button class="btn btn-outline-secondary btn-sm ms-2" onclick="exportResults()">
                            <i class="fas fa-download"></i> å¯¼å‡º
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="scrapingResults">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-database fa-2x mb-2"></i>
                            <p>é‡‡é›†ç»“æœå°†åœ¨è¿™é‡Œå®æ—¶æ˜¾ç¤º</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- è¿›åº¦æ¨¡æ€æ¡† -->
<div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog fa-spin me-2"></i>
                    æ­£åœ¨å¤„ç†...
                </h5>
            </div>
            <div class="modal-body">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%" id="progressBar"></div>
                </div>
                <p class="mb-0" id="progressText">æ­£åœ¨åˆå§‹åŒ–...</p>
            </div>
        </div>
    </div>
</div>

<!-- åšä¸»åˆ—è¡¨ç®¡ç†æ¨¡æ€æ¡† -->
<div class="modal fade" id="influencerListModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-users me-2"></i>
                    åšä¸»ç®¡ç†
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- æœç´¢å’Œç­›é€‰ -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="influencerSearch" 
                               placeholder="æœç´¢åšä¸»åç§°æˆ–ç”¨æˆ·å">
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="influencerCategoryFilter">
                            <option value="">å…¨éƒ¨åˆ†ç±»</option>
                            <option value="æé’±">æé’±</option>
                            <option value="æŠ•æ”¾">æŠ•æ”¾</option>
                            <option value="å‰¯ä¸šå¹²è´§">å‰¯ä¸šå¹²è´§</option>
                            <option value="æƒ…ç»ªç±»">æƒ…ç»ªç±»</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary" onclick="searchInfluencers()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                
                <!-- åšä¸»åˆ—è¡¨ -->
                <div id="influencerListContainer">
                    <div class="text-center py-4">
                        <div class="loading-spinner"></div>
                        <p class="mt-2">åŠ è½½ä¸­...</p>
                    </div>
                </div>
                
                <!-- åˆ†é¡µ -->
                <nav id="influencerPagination" class="mt-3" style="display: none;">
                    <ul class="pagination justify-content-center" id="paginationList">
                        <!-- åŠ¨æ€ç”Ÿæˆåˆ†é¡µ -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- ç¼–è¾‘åšä¸»æ¨¡æ€æ¡† -->
<div class="modal fade" id="editInfluencerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>
                    ç¼–è¾‘åšä¸»ä¿¡æ¯
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editInfluencerForm">
                    <input type="hidden" id="editInfluencerId">
                    <div class="mb-3">
                        <label for="editInfluencerName" class="form-label">åšä¸»åç§°</label>
                        <input type="text" class="form-control" id="editInfluencerName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editInfluencerCategory" class="form-label">åˆ†ç±»</label>
                        <select class="form-select" id="editInfluencerCategory">
                            <option value="æé’±">æé’±</option>
                            <option value="æŠ•æ”¾">æŠ•æ”¾</option>
                            <option value="å‰¯ä¸šå¹²è´§">å‰¯ä¸šå¹²è´§</option>
                            <option value="æƒ…ç»ªç±»">æƒ…ç»ªç±»</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editInfluencerDescription" class="form-label">æè¿°</label>
                        <textarea class="form-control" id="editInfluencerDescription" rows="3"></textarea>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="editInfluencerActive">
                        <label class="form-check-label" for="editInfluencerActive">
                            å¯ç”¨çŠ¶æ€
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="updateInfluencer()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<style>
.structure-node {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.75rem;
    margin: 0.5rem 0;
    background: #f8f9fa;
    position: relative;
}

.structure-node.selected {
    border-color: #0d6efd;
    background: #e7f3ff;
}

.structure-node .node-info {
    font-size: 0.875rem;
    color: #6c757d;
}

.structure-node .node-selector {
    font-family: 'Courier New', monospace;
    background: #e9ecef;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
}

.field-mapping-item {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 1rem;
    background: #ffffff;
}

.field-mapping-item .field-name {
    font-weight: 600;
    color: #495057;
}

.selector-input {
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
}

.result-item {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 0.75rem;
    background: #ffffff;
    transition: all 0.2s;
}

.result-item:hover {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.result-item .item-index {
    background: #6c757d;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 600;
}

.result-item .item-content {
    font-size: 0.875rem;
    line-height: 1.4;
}

.result-item .item-meta {
    font-size: 0.75rem;
    color: #6c757d;
}

.loading-spinner {
    display: inline-block;
    width: 1rem;
    height: 1rem;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
let currentAnalysis = null;
let scrapingInProgress = false;
let collectedData = [];
let influencerList = [];
let currentInfluencerPage = 1;
let totalInfluencerPages = 1;

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadInfluencerOptions();
});

// åˆ†æé¡µé¢ç»“æ„
async function analyzePageStructure() {
    const url = document.getElementById('targetUrl').value;
    const pageType = document.getElementById('pageType').value;
    
    if (!url) {
        alert('è¯·è¾“å…¥ç›®æ ‡URL');
        return;
    }
    
    showProgress('æ­£åœ¨åˆ†æé¡µé¢ç»“æ„...', 20);
    
    try {
        const response = await fetch('/api/analyze-page-structure', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                url: url,
                page_type: pageType
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            currentAnalysis = result.data;
            displayAnalysisResults(result.data);
            displayStructureVisualization(result.data);
            displayFieldMapping(result.data);
            document.getElementById('startScrapingBtn').disabled = false;
            showProgress('é¡µé¢ç»“æ„åˆ†æå®Œæˆ', 100);
            setTimeout(hideProgress, 1000);
        } else {
            throw new Error(result.message || 'åˆ†æå¤±è´¥');
        }
    } catch (error) {
        console.error('åˆ†æé¡µé¢ç»“æ„å¤±è´¥:', error);
        alert('åˆ†æé¡µé¢ç»“æ„å¤±è´¥: ' + error.message);
        hideProgress();
    }
}

// æ˜¾ç¤ºåˆ†æç»“æœ
function displayAnalysisResults(data) {
    const container = document.getElementById('analysisResults');
    
    const pageInfo = data.page_info || {};
    const listItems = data.list_items || [];
    const dataFields = data.data_fields || {};
    
    container.innerHTML = `
        <div class="mb-3">
            <h6 class="text-primary">é¡µé¢ä¿¡æ¯</h6>
            <div class="small">
                <div><strong>ç±»å‹:</strong> ${pageInfo.page_type || 'unknown'}</div>
                <div><strong>åŸŸå:</strong> ${pageInfo.domain || 'unknown'}</div>
                <div><strong>æ ‡é¢˜:</strong> ${pageInfo.title || 'unknown'}</div>
            </div>
        </div>
        
        <div class="mb-3">
            <h6 class="text-success">è¯†åˆ«ç»“æœ</h6>
            <div class="small">
                <div><i class="fas fa-list text-info"></i> åˆ—è¡¨é¡¹: <strong>${listItems.length}</strong> ä¸ª</div>
                <div><i class="fas fa-tags text-warning"></i> æ•°æ®å­—æ®µ: <strong>${Object.keys(dataFields).length}</strong> ç±»</div>
            </div>
        </div>
        
        <div class="mb-3">
            <h6 class="text-info">å­—æ®µç±»å‹</h6>
            <div class="small">
                ${Object.entries(dataFields).map(([type, selectors]) => 
                    `<div><span class="badge bg-secondary me-1">${type}</span> ${selectors.length} ä¸ªé€‰æ‹©å™¨</div>`
                ).join('')}
            </div>
        </div>
    `;
}

// æ˜¾ç¤ºç»“æ„å¯è§†åŒ–
function displayStructureVisualization(data) {
    const container = document.getElementById('structureVisualization');
    
    const listItems = data.list_items || [];
    const dataFields = data.data_fields || {};
    
    let html = '<div class="structure-tree">';
    
    if (listItems.length > 0) {
        html += `
            <div class="structure-node" onclick="selectNode(this)">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-list text-primary me-2"></i>
                        <strong>åˆ—è¡¨å®¹å™¨</strong>
                    </div>
                    <span class="badge bg-primary">${listItems.length} é¡¹</span>
                </div>
                <div class="node-info mt-2">
                    <div class="node-selector">${listItems[0].selector}</div>
                </div>
            </div>
        `;
        
        // æ˜¾ç¤ºå­—æ®µç»“æ„
        Object.entries(dataFields).forEach(([fieldType, selectors]) => {
            if (selectors.length > 0) {
                html += `
                    <div class="structure-node ms-4" onclick="selectNode(this)">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-tag text-success me-2"></i>
                                <strong>${getFieldDisplayName(fieldType)}</strong>
                            </div>
                            <span class="badge bg-success">${selectors.length} é€‰æ‹©å™¨</span>
                        </div>
                        <div class="node-info mt-2">
                            ${selectors.map(selector => 
                                `<div class="node-selector mb-1">${selector}</div>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }
        });
    } else {
        html += `
            <div class="text-center text-muted py-4">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <p>æœªè¯†åˆ«åˆ°æœ‰æ•ˆçš„é¡µé¢ç»“æ„</p>
            </div>
        `;
    }
    
    html += '</div>';
    container.innerHTML = html;
}

// æ˜¾ç¤ºå­—æ®µæ˜ å°„é…ç½®
function displayFieldMapping(data) {
    const container = document.getElementById('fieldMapping');
    const dataFields = data.data_fields || {};
    
    let html = '';
    
    Object.entries(dataFields).forEach(([fieldType, selectors]) => {
        if (selectors.length > 0) {
            html += `
                <div class="field-mapping-item">
                    <div class="field-name mb-2">
                        <i class="fas fa-tag text-primary me-2"></i>
                        ${getFieldDisplayName(fieldType)}
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">ä¸»é€‰æ‹©å™¨</label>
                        <input type="text" class="form-control selector-input" 
                               value="${selectors[0]}" 
                               data-field="${fieldType}" 
                               data-type="primary">
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">å¤‡ç”¨é€‰æ‹©å™¨</label>
                        <textarea class="form-control selector-input" rows="2" 
                                  data-field="${fieldType}" 
                                  data-type="fallback">${selectors.slice(1).join('\n')}</textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" 
                               id="enable_${fieldType}" checked>
                        <label class="form-check-label small" for="enable_${fieldType}">
                            å¯ç”¨æ­¤å­—æ®µ
                        </label>
                    </div>
                </div>
            `;
        }
    });
    
    if (html) {
        container.innerHTML = html;
    } else {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-info-circle fa-2x mb-2"></i>
                <p>æ²¡æœ‰å¯é…ç½®çš„å­—æ®µ</p>
            </div>
        `;
    }
}

// å¼€å§‹æ™ºèƒ½é‡‡é›†
async function startIntelligentScraping() {
    if (scrapingInProgress) {
        alert('é‡‡é›†æ­£åœ¨è¿›è¡Œä¸­...');
        return;
    }
    
    if (!currentAnalysis) {
        alert('è¯·å…ˆåˆ†æé¡µé¢ç»“æ„');
        return;
    }
    
    scrapingInProgress = true;
    collectedData = [];
    
    const maxItems = parseInt(document.getElementById('maxItems').value);
    const scrollDelay = parseFloat(document.getElementById('scrollDelay').value);
    const maxScrolls = parseInt(document.getElementById('maxScrolls').value);
    const enableSmartScroll = document.getElementById('enableSmartScroll').checked;
    
    // æ”¶é›†å­—æ®µé…ç½®
    const fieldConfig = {};
    document.querySelectorAll('.field-mapping-item').forEach(item => {
        const fieldType = item.querySelector('[data-field]').dataset.field;
        const enabled = item.querySelector(`#enable_${fieldType}`).checked;
        
        if (enabled) {
            const primarySelector = item.querySelector('[data-type="primary"]').value;
            const fallbackSelectors = item.querySelector('[data-type="fallback"]').value
                .split('\n').filter(s => s.trim());
            
            fieldConfig[fieldType] = {
                primary: primarySelector,
                fallback: fallbackSelectors
            };
        }
    });
    
    showProgress('æ­£åœ¨å¯åŠ¨æ™ºèƒ½é‡‡é›†...', 10);
    
    try {
        const response = await fetch('/api/start-intelligent-scraping', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                analysis: currentAnalysis,
                config: {
                    max_items: maxItems,
                    scroll_delay: scrollDelay,
                    max_scrolls: maxScrolls,
                    enable_smart_scroll: enableSmartScroll,
                    field_config: fieldConfig
                }
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // å¼€å§‹è½®è¯¢é‡‡é›†è¿›åº¦
            pollScrapingProgress(result.task_id);
        } else {
            throw new Error(result.message || 'å¯åŠ¨é‡‡é›†å¤±è´¥');
        }
    } catch (error) {
        console.error('å¯åŠ¨æ™ºèƒ½é‡‡é›†å¤±è´¥:', error);
        alert('å¯åŠ¨æ™ºèƒ½é‡‡é›†å¤±è´¥: ' + error.message);
        scrapingInProgress = false;
        hideProgress();
    }
}

// è½®è¯¢é‡‡é›†è¿›åº¦
async function pollScrapingProgress(taskId) {
    try {
        const response = await fetch(`/api/scraping-progress/${taskId}`);
        const result = await response.json();
        
        if (result.success) {
            const progress = result.data;
            
            // æ›´æ–°è¿›åº¦
            const percentage = Math.min((progress.collected_count / progress.target_count) * 100, 100);
            showProgress(`å·²é‡‡é›† ${progress.collected_count}/${progress.target_count} æ¡æ•°æ®`, percentage);
            
            // æ›´æ–°ç»“æœæ˜¾ç¤º
            if (progress.latest_data && progress.latest_data.length > 0) {
                updateScrapingResults(progress.latest_data);
            }
            
            // æ£€æŸ¥æ˜¯å¦å®Œæˆ
            if (progress.status === 'completed' || progress.status === 'failed') {
                scrapingInProgress = false;
                hideProgress();
                
                if (progress.status === 'completed') {
                    alert(`é‡‡é›†å®Œæˆï¼å…±é‡‡é›†åˆ° ${progress.collected_count} æ¡æ•°æ®`);
                } else {
                    alert('é‡‡é›†å¤±è´¥: ' + (progress.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } else {
                // ç»§ç»­è½®è¯¢
                setTimeout(() => pollScrapingProgress(taskId), 2000);
            }
        } else {
            throw new Error(result.message || 'è·å–è¿›åº¦å¤±è´¥');
        }
    } catch (error) {
        console.error('è·å–é‡‡é›†è¿›åº¦å¤±è´¥:', error);
        scrapingInProgress = false;
        hideProgress();
    }
}

// æ›´æ–°é‡‡é›†ç»“æœæ˜¾ç¤º
function updateScrapingResults(newData) {
    const container = document.getElementById('scrapingResults');
    
    newData.forEach(item => {
        if (!collectedData.find(existing => existing.index === item.index)) {
            collectedData.push(item);
            
            const resultHtml = `
                <div class="result-item" data-index="${item.index}">
                    <div class="d-flex align-items-start">
                        <div class="item-index me-3">${item.index + 1}</div>
                        <div class="flex-grow-1">
                            <div class="item-content mb-2">
                                ${item.content ? item.content.substring(0, 200) + (item.content.length > 200 ? '...' : '') : 'æ— å†…å®¹'}
                            </div>
                            <div class="item-meta d-flex flex-wrap gap-2">
                                ${item.metadata && item.metadata.username ? 
                                    `<span class="badge bg-info">@${item.metadata.username}</span>` : ''}
                                ${item.metadata && item.metadata.publish_time ? 
                                    `<span class="badge bg-secondary">${new Date(item.metadata.publish_time).toLocaleString()}</span>` : ''}
                                ${item.interactions ? 
                                    `<span class="badge bg-success">â¤ï¸ ${item.interactions.likes || 0}</span>` : ''}
                                ${item.interactions ? 
                                    `<span class="badge bg-warning">ğŸ’¬ ${item.interactions.comments || 0}</span>` : ''}
                                ${item.interactions ? 
                                    `<span class="badge bg-primary">ğŸ”„ ${item.interactions.retweets || 0}</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            if (container.innerHTML.includes('é‡‡é›†ç»“æœå°†åœ¨è¿™é‡Œå®æ—¶æ˜¾ç¤º')) {
                container.innerHTML = resultHtml;
            } else {
                container.insertAdjacentHTML('afterbegin', resultHtml);
            }
        }
    });
    
    // æ›´æ–°è®¡æ•°
    document.getElementById('collectedCount').textContent = collectedData.length;
}

// å¯¼å‡ºç»“æœ
function exportResults() {
    if (collectedData.length === 0) {
        alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
        return;
    }
    
    const dataStr = JSON.stringify(collectedData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `scraping_results_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
    link.click();
}

// å·¥å…·å‡½æ•°
function getFieldDisplayName(fieldType) {
    const displayNames = {
        'text_content': 'æ–‡æœ¬å†…å®¹',
        'links': 'é“¾æ¥',
        'images': 'å›¾ç‰‡',
        'metadata': 'å…ƒæ•°æ®',
        'interactions': 'äº¤äº’æ•°æ®'
    };
    return displayNames[fieldType] || fieldType;
}

function selectNode(node) {
    document.querySelectorAll('.structure-node').forEach(n => n.classList.remove('selected'));
    node.classList.add('selected');
}

function showStructureView() {
    // å®ç°ç»“æ„è§†å›¾åˆ‡æ¢
    console.log('åˆ‡æ¢åˆ°ç»“æ„è§†å›¾');
}

function showSelectorView() {
    // å®ç°é€‰æ‹©å™¨è§†å›¾åˆ‡æ¢
    console.log('åˆ‡æ¢åˆ°é€‰æ‹©å™¨è§†å›¾');
}

function showPreviewView() {
    // å®ç°é¢„è§ˆè§†å›¾åˆ‡æ¢
    console.log('åˆ‡æ¢åˆ°é¢„è§ˆè§†å›¾');
}

function showProgress(text, percentage) {
    document.getElementById('progressText').textContent = text;
    document.getElementById('progressBar').style.width = percentage + '%';
    new bootstrap.Modal(document.getElementById('progressModal')).show();
}

function hideProgress() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
    if (modal) {
        modal.hide();
    }
}

// åšä¸»ç®¡ç†ç›¸å…³å‡½æ•°

// æ·»åŠ åšä¸»
async function addInfluencer() {
    const url = document.getElementById('influencerUrl').value.trim();
    const name = document.getElementById('influencerName').value.trim();
    const category = document.getElementById('influencerCategory').value;
    const description = document.getElementById('influencerDescription').value.trim();
    
    if (!url || !name) {
        alert('è¯·å¡«å†™åšä¸»URLå’Œåç§°');
        return;
    }
    
    try {
        const response = await fetch('/api/influencers', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name,
                profile_url: url,
                category: category,
                description: description
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('åšä¸»æ·»åŠ æˆåŠŸï¼');
            // æ¸…ç©ºè¡¨å•
            document.getElementById('influencerUrl').value = '';
            document.getElementById('influencerName').value = '';
            document.getElementById('influencerDescription').value = '';
            // é‡æ–°åŠ è½½åšä¸»é€‰é¡¹
            loadInfluencerOptions();
        } else {
            alert('æ·»åŠ å¤±è´¥: ' + result.error);
        }
    } catch (error) {
        console.error('æ·»åŠ åšä¸»å¤±è´¥:', error);
        alert('æ·»åŠ åšä¸»å¤±è´¥: ' + error.message);
    }
}

// åŠ è½½åšä¸»é€‰é¡¹åˆ°ä¸‹æ‹‰æ¡†
async function loadInfluencerOptions() {
    try {
        const response = await fetch('/api/influencers?per_page=100');
        const result = await response.json();
        
        if (result.success) {
            const select = document.getElementById('selectedInfluencers');
            select.innerHTML = '';
            
            result.data.influencers.forEach(influencer => {
                if (influencer.is_active) {
                    const option = document.createElement('option');
                    option.value = influencer.id;
                    option.textContent = `${influencer.name} (@${influencer.username}) - ${influencer.category}`;
                    select.appendChild(option);
                }
            });
        }
    } catch (error) {
        console.error('åŠ è½½åšä¸»é€‰é¡¹å¤±è´¥:', error);
    }
}

// æ˜¾ç¤ºåšä¸»åˆ—è¡¨ç®¡ç†
function showInfluencerList() {
    const modal = new bootstrap.Modal(document.getElementById('influencerListModal'));
    modal.show();
    loadInfluencerList();
}

// åŠ è½½åšä¸»åˆ—è¡¨
async function loadInfluencerList(page = 1, search = '', category = '') {
    try {
        const params = new URLSearchParams({
            page: page,
            per_page: 10
        });
        
        if (search) params.append('search', search);
        if (category) params.append('category', category);
        
        const response = await fetch(`/api/influencers?${params}`);
        const result = await response.json();
        
        if (result.success) {
            displayInfluencerList(result.data);
            updateInfluencerPagination(result.data);
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        console.error('åŠ è½½åšä¸»åˆ—è¡¨å¤±è´¥:', error);
        document.getElementById('influencerListContainer').innerHTML = `
            <div class="text-center py-4 text-danger">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <p>åŠ è½½å¤±è´¥: ${error.message}</p>
            </div>
        `;
    }
}

// æ˜¾ç¤ºåšä¸»åˆ—è¡¨
function displayInfluencerList(data) {
    const container = document.getElementById('influencerListContainer');
    
    if (data.influencers.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4 text-muted">
                <i class="fas fa-users fa-2x mb-2"></i>
                <p>æš‚æ— åšä¸»æ•°æ®</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="list-group">';
    
    data.influencers.forEach(influencer => {
        const statusBadge = influencer.is_active ? 
            '<span class="badge bg-success">å¯ç”¨</span>' : 
            '<span class="badge bg-secondary">ç¦ç”¨</span>';
        
        const lastScraped = influencer.last_scraped ? 
            new Date(influencer.last_scraped).toLocaleString() : 'ä»æœªæŠ“å–';
        
        html += `
            <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">
                            ${influencer.name}
                            <span class="badge bg-primary ms-2">${influencer.category}</span>
                            ${statusBadge}
                        </h6>
                        <p class="mb-1 text-muted">@${influencer.username}</p>
                        <p class="mb-1 small">${influencer.description || 'æ— æè¿°'}</p>
                        <small class="text-muted">æœ€åæŠ“å–: ${lastScraped}</small>
                    </div>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-primary" onclick="editInfluencer(${influencer.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="scrapeInfluencer(${influencer.id})">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteInfluencer(${influencer.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// æ›´æ–°åˆ†é¡µ
function updateInfluencerPagination(data) {
    const pagination = document.getElementById('influencerPagination');
    const paginationList = document.getElementById('paginationList');
    
    if (data.pages <= 1) {
        pagination.style.display = 'none';
        return;
    }
    
    pagination.style.display = 'block';
    currentInfluencerPage = data.current_page;
    totalInfluencerPages = data.pages;
    
    let html = '';
    
    // ä¸Šä¸€é¡µ
    if (currentInfluencerPage > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadInfluencerList(${currentInfluencerPage - 1})">ä¸Šä¸€é¡µ</a></li>`;
    }
    
    // é¡µç 
    for (let i = Math.max(1, currentInfluencerPage - 2); i <= Math.min(totalInfluencerPages, currentInfluencerPage + 2); i++) {
        const active = i === currentInfluencerPage ? 'active' : '';
        html += `<li class="page-item ${active}"><a class="page-link" href="#" onclick="loadInfluencerList(${i})">${i}</a></li>`;
    }
    
    // ä¸‹ä¸€é¡µ
    if (currentInfluencerPage < totalInfluencerPages) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadInfluencerList(${currentInfluencerPage + 1})">ä¸‹ä¸€é¡µ</a></li>`;
    }
    
    paginationList.innerHTML = html;
}

// æœç´¢åšä¸»
function searchInfluencers() {
    const search = document.getElementById('influencerSearch').value;
    const category = document.getElementById('influencerCategoryFilter').value;
    loadInfluencerList(1, search, category);
}

// ç¼–è¾‘åšä¸»
async function editInfluencer(influencerId) {
    try {
        // è·å–åšä¸»ä¿¡æ¯
        const response = await fetch(`/api/influencers?per_page=100`);
        const result = await response.json();
        
        if (result.success) {
            const influencer = result.data.influencers.find(inf => inf.id === influencerId);
            if (influencer) {
                // å¡«å……ç¼–è¾‘è¡¨å•
                document.getElementById('editInfluencerId').value = influencer.id;
                document.getElementById('editInfluencerName').value = influencer.name;
                document.getElementById('editInfluencerCategory').value = influencer.category;
                document.getElementById('editInfluencerDescription').value = influencer.description || '';
                document.getElementById('editInfluencerActive').checked = influencer.is_active;
                
                // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
                const modal = new bootstrap.Modal(document.getElementById('editInfluencerModal'));
                modal.show();
            }
        }
    } catch (error) {
        console.error('è·å–åšä¸»ä¿¡æ¯å¤±è´¥:', error);
        alert('è·å–åšä¸»ä¿¡æ¯å¤±è´¥');
    }
}

// æ›´æ–°åšä¸»ä¿¡æ¯
async function updateInfluencer() {
    const influencerId = document.getElementById('editInfluencerId').value;
    const name = document.getElementById('editInfluencerName').value.trim();
    const category = document.getElementById('editInfluencerCategory').value;
    const description = document.getElementById('editInfluencerDescription').value.trim();
    const isActive = document.getElementById('editInfluencerActive').checked;
    
    if (!name) {
        alert('è¯·å¡«å†™åšä¸»åç§°');
        return;
    }
    
    try {
        const response = await fetch(`/api/influencers/${influencerId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name,
                category: category,
                description: description,
                is_active: isActive
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('åšä¸»ä¿¡æ¯æ›´æ–°æˆåŠŸï¼');
            // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
            const modal = bootstrap.Modal.getInstance(document.getElementById('editInfluencerModal'));
            modal.hide();
            // é‡æ–°åŠ è½½åˆ—è¡¨
            loadInfluencerList(currentInfluencerPage);
            loadInfluencerOptions();
        } else {
            alert('æ›´æ–°å¤±è´¥: ' + result.error);
        }
    } catch (error) {
        console.error('æ›´æ–°åšä¸»å¤±è´¥:', error);
        alert('æ›´æ–°åšä¸»å¤±è´¥: ' + error.message);
    }
}

// åˆ é™¤åšä¸»
async function deleteInfluencer(influencerId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåšä¸»å—ï¼Ÿ')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/influencers/${influencerId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('åšä¸»åˆ é™¤æˆåŠŸï¼');
            loadInfluencerList(currentInfluencerPage);
            loadInfluencerOptions();
        } else {
            alert('åˆ é™¤å¤±è´¥: ' + result.error);
        }
    } catch (error) {
        console.error('åˆ é™¤åšä¸»å¤±è´¥:', error);
        alert('åˆ é™¤åšä¸»å¤±è´¥: ' + error.message);
    }
}

// æŠ“å–å•ä¸ªåšä¸»
async function scrapeInfluencer(influencerId) {
    alert('å•ä¸ªåšä¸»æŠ“å–åŠŸèƒ½å¼€å‘ä¸­...');
}

// æŠ“å–é€‰ä¸­çš„åšä¸»
async function startInfluencerScraping() {
    const selectedOptions = document.getElementById('selectedInfluencers').selectedOptions;
    
    if (selectedOptions.length === 0) {
        alert('è¯·é€‰æ‹©è¦æŠ“å–çš„åšä¸»');
        return;
    }
    
    const selectedIds = Array.from(selectedOptions).map(option => parseInt(option.value));
    
    // è¿™é‡Œå¯ä»¥å®ç°æ‰¹é‡æŠ“å–åšä¸»çš„åŠŸèƒ½
    alert(`å°†æŠ“å– ${selectedIds.length} ä¸ªåšä¸»çš„å†…å®¹ï¼ŒåŠŸèƒ½å¼€å‘ä¸­...`);
    
    // TODO: å®ç°æ‰¹é‡æŠ“å–é€»è¾‘
    console.log('é€‰ä¸­çš„åšä¸»ID:', selectedIds);
}

</script>
{% endblock %}